<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NES Manager Notes Checklist — v40</title>
  <!-- NES Checklist PWA v40 (full replacement) | built UTC -->
  <meta name="theme-color" content="#003366">
  <style>
    :root{
      --bg:#f8fafc;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --brand:#0b4da2;
      --brand-ink:#0b4da2;
      --card:#ffffff;
      --btn:#0b4da2;
      --btn-ink:#ffffff;
      --btn-ghost:#eef2f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:var(--card);
      border-bottom:1px solid var(--line);
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; color:var(--brand-ink)}
    .brand .logo{width:36px; height:36px; border-radius:8px; background:#0b4da2; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:900}
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--line); background:var(--btn-ghost); color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer}
    .btn-primary{ background:var(--btn); color:var(--btn-ink); border-color:transparent }
    .btn:hover{ filter:brightness(.98) }
    main{ max-width:900px; margin:16px auto; padding:0 14px 80px }
    section.card{
      background:var(--card); border:1px solid var(--line); border-radius:14px; margin:14px 0;
      box-shadow:0 2px 10px rgba(2,6,23,.04);
    }
    section.card > header{
      position:static; border:none; background:transparent; padding:12px 14px; justify-content:flex-start; gap:12px;
    }
    section.card h2{ margin:0; font-size:18px }
    ul.list{ list-style:none; margin:0; padding:0 14px 12px 14px }
    li.item{
      display:flex; align-items:center; gap:10px;
      padding:10px 6px; border-bottom:1px solid var(--line);
    }
    li.item:last-child{ border-bottom:none }
    /* Checkboxes: simple black outline, white center; centered with text */
    input[type="checkbox"]{
      width:18px; height:18px; margin:0; flex:0 0 auto;
      appearance:none; -webkit-appearance:none; outline:none;
      border:2px solid #111; border-radius:3px; background:#fff; display:grid; place-content:center;
    }
    input[type="checkbox"]::after{
      content:""; width:12px; height:12px; transform:scale(0); transition:transform .08s ease-out;
      background:#111;
    }
    input[type="checkbox"]:checked::after{ transform:scale(1) }
    .label{ flex:1; font-weight:600; line-height:1.25 }
    .hint{ color:var(--muted); font-size:12px }
    /* Inline action button next to label */
    .appt-action{
      margin-left:8px; font-size:12px; padding:4px 8px; border-radius:6px; border:1px solid var(--line);
      background:var(--btn-ghost); cursor:pointer;
    }
    .appt-action:hover{ filter:brightness(.98) }
    /* Modal */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center; }
    .modal-card{ background:#fff; color:#111; max-width:560px; width:92vw; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.25); overflow:hidden; }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--line) }
    .modal-body{ padding:14px 16px; display:flex; flex-direction:column; gap:10px }
    input[type="date"], input[type="time"], input[type="text"], select{
      padding:8px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }
    /* Print */
    @media print{
      header, .toolbar, .util-actions { display:none !important; }
      body{ background:#fff }
      section.card{ break-inside:avoid }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">NES</div>
      NES Manager Notes Checklist <span class="hint">v40</span>
    </div>
    <div class="row">
      <label for="sheetSelect" class="hint">Sheet</label>
      <select id="sheetSelect">
        <option value="default">Default</option>
        <option value="HouseA">House A</option>
        <option value="HouseB">House B</option>
      </select>
      <label for="checklistDate" class="hint">Date</label>
      <input type="date" id="checklistDate">
    </div>
  </header>

  <main>
    <!-- Save/Load toolbar -->
    <div class="toolbar util-actions" style="justify-content:flex-end;">
      <button id="btnSaveAll" class="btn">Save Data</button>
      <button id="btnLoadAll" class="btn">Load Data</button>
      <input id="loadFileInput" type="file" accept="application/json" style="display:none">
    </div>

    <!-- Monthly -->
    <section class="card" id="sec-monthly">
      <header><h2>Monthly</h2></header>
      <ul class="list" id="list-monthly">
        <li class="item">
          <input type="checkbox" data-key="financials">
          <span class="label">Financials</span>
        </li>
        <li class="item">
          <input type="checkbox" data-key="client-medical-assesment">
          <span class="label">Client Medical Assesment Form</span>
        </li>
      </ul>
    </section>

    <!-- Bi-Weekly -->
    <section class="card" id="sec-biweekly">
      <header><h2>Bi-Weekly</h2></header>
      <ul class="list" id="list-biweekly">
        <li class="item">
          <input type="checkbox" data-key="checkin-times-accuracy">
          <span class="label">Check in Times for Accuracy</span>
        </li>
        <li class="item">
          <input type="checkbox" data-key="timesheets">
          <span class="label">Timesheets</span>
        </li>
      </ul>
    </section>

    <!-- First of Month -->
    <section class="card" id="sec-first">
      <header><h2>First of the Month</h2></header>
      <ul class="list" id="list-first">
        <li class="item">
          <input type="checkbox" data-key="fire-drill">
          <span class="label">Fire Drill</span>
        </li>
        <li class="item">
          <input type="checkbox" data-key="disaster">
          <span class="label">Disaster</span>
        </li>
        <li class="item">
          <input type="checkbox" data-key="prn-start-count">
          <span class="label">PRN Start Count</span>
        </li>
      </ul>
    </section>

    <!-- Custom -->
    <section class="card" id="sec-custom">
      <header><h2>Custom</h2></header>
      <ul class="list" id="list-custom"></ul>
      <div style="padding:0 14px 14px 14px; display:flex; gap:8px;">
        <input id="customText" type="text" placeholder="New item text">
        <button id="btnAddRow" class="btn btn-primary">+ Add row</button>
      </div>
    </section>
  </main>

  <!-- Medical Appointment Modal (no alarm) -->
  <div id="apptModal" class="modal" role="dialog" aria-modal="true" aria-label="Medical Appointment">
    <div class="modal-card">
      <div class="modal-header">
        <div style="font-weight:700;font-size:18px;">Medical Appointment</div>
        <button id="apptCloseBtn" class="btn">Close</button>
      </div>
      <div class="modal-body">
        <label style="font-weight:600;">Date</label>
        <input type="date" id="apptDate">
        <label style="font-weight:600;">Time</label>
        <input type="time" id="apptTime">
        <label style="font-weight:600;">Notes (optional)</label>
        <input type="text" id="apptNotes" placeholder="Provider name, address, reason…">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <button id="apptSaveBtn" class="btn btn-primary">Save</button>
          <button id="apptIcsBtn" class="btn" title="Create calendar file">Add to Calendar (.ics)</button>
          <button id="apptDeviceCalBtn" class="btn">Open in Calendar</button>
        </div>
        <div id="apptListWrap" style="margin-top:10px;">
          <div style="font-weight:700;margin-bottom:6px;">Saved Appointments</div>
          <ul id="apptList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Version =====
    const APP_VERSION = "40";

    // ===== Helpers =====
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const keyFor = (prefix, sheet) => prefix + "|" + sheet;

    function currentSheet(){
      const s = $("#sheetSelect");
      return s && s.value ? s.value : "default";
    }
    function todayISO(){
      const d = new Date(), m = String(d.getMonth()+1).padStart(2,"0"), day = String(d.getDate()).padStart(2,"0");
      return d.getFullYear()+"-"+m+"-"+day;
    }

    // ===== Date init =====
    const dateInput = $("#checklistDate");
    if (dateInput && !dateInput.value) dateInput.value = todayISO();

    // ===== Water droplet sound (on check only) via WebAudio =====
    let audioCtx = null;
    function playDroplet(){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const ctx = audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.setValueAtTime(880, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(280, ctx.currentTime + 0.12);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.14);
        o.connect(g).connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.15);
      }catch(e){ /* ignore */ }
    }

    // ===== Checklist state (autosave) =====
    const CK_PREFIX = "nes.ck";
    function loadState(){
      try{
        const raw = localStorage.getItem(keyFor(CK_PREFIX,currentSheet()));
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function saveState(state){
      try{
        localStorage.setItem(keyFor(CK_PREFIX,currentSheet()), JSON.stringify(state||{}));
      }catch(e){}
    }
    function restoreChecks(){
      const st = loadState();
      $$('input[type="checkbox"]').forEach(cb => {
        const k = cb.dataset.key;
        if(!k) return;
        cb.checked = !!st[k];
      });
    }
    function wireChecks(){
      $$('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const st = loadState();
          const k = cb.dataset.key;
          if(k){
            st[k] = cb.checked ? 1 : 0;
            saveState(st);
          }
          if (cb.checked) playDroplet();
        });
      });
    }

    // ===== Save/Load toolbar =====
    function exportAll(){
      const data = {};
      try{
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          try{ data[k] = localStorage.getItem(k); }catch(e){}
        }
        const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "nes_checklist_backup.json";
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      }catch(e){ alert("Export failed: "+e); }
    }
    function importAllFromFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result||"{}");
          for(const k in obj){
            if(Object.prototype.hasOwnProperty.call(obj,k)){
              try{ localStorage.setItem(k, obj[k]); }catch(e){}
            }
          }
          alert("Data loaded. The page will refresh to apply it.");
          setTimeout(()=>location.reload(), 400);
        }catch(e){ alert("Bad file format."); }
      };
      reader.readAsText(file);
    }
    $("#btnSaveAll")?.addEventListener("click", exportAll);
    $("#btnLoadAll")?.addEventListener("click", ()=> $("#loadFileInput").click());
    $("#loadFileInput")?.addEventListener("change", e => {
      const f = e.target.files?.[0]; if(f) importAllFromFile(f);
    });

    // ===== Custom rows =====
    const CUST_PREFIX = "nes.custom";
    function loadCustom(){
      try{
        const raw = localStorage.getItem(keyFor(CUST_PREFIX,currentSheet()));
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveCustom(list){
      try{ localStorage.setItem(keyFor(CUST_PREFIX,currentSheet()), JSON.stringify(list||[])); }catch(e){}
    }
    function renderCustom(){
      const ul = $("#list-custom"); if(!ul) return;
      ul.innerHTML = "";
      const items = loadCustom();
      if(!items.length){
        const li = document.createElement("li");
        li.className="item"; li.innerHTML = '<span class="hint">No custom rows yet.</span>';
        ul.appendChild(li);
        return;
      }
      items.forEach((txt, idx) => {
        const li = document.createElement("li");
        li.className="item";
        li.innerHTML = '<input type="checkbox" data-key="custom-'+idx+'"><span class="label"></span>'
                     + '<button class="btn" data-act="del" style="margin-left:auto">Delete</button>';
        li.querySelector(".label").textContent = txt;
        ul.appendChild(li);
      });
      // Wire deletes
      $$('#list-custom [data-act="del"]').forEach((b, i) => {
        b.addEventListener("click", () => {
          const it = loadCustom(); it.splice(i,1); saveCustom(it); renderCustom(); restoreChecks(); wireChecks();
        });
      });
    }
    $("#btnAddRow")?.addEventListener("click", () => {
      const t = ($("#customText")?.value||"").trim();
      if(!t){ alert("Enter text for the new row"); return; }
      const it = loadCustom(); it.push(t); saveCustom(it);
      $("#customText").value="";
      renderCustom(); restoreChecks(); wireChecks();
    });

    // ===== Medical Appointment (no alarm) =====
    const APPT_PREFIX = "nes.appts.";
    const apptKey = () => keyFor(APPT_PREFIX, currentSheet());
    function loadAppts(){ try{ const raw = localStorage.getItem(apptKey()); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
    function saveAppts(list){ try{ localStorage.setItem(apptKey(), JSON.stringify(list||[])); }catch(e){} }

    function ensureApptButton(){
      const labels = $$(".label, label, li .label");
      labels.forEach(el => {
        const txt = (el.textContent||"").trim().toLowerCase();
        if(txt.indexOf("client medical assesment form")!==-1){
          const next = el.nextSibling;
          if(next && next.classList && next.classList.contains("appt-action")) return;
          const btn = document.createElement("button");
          btn.className="appt-action"; btn.type="button"; btn.textContent="Medical Appt";
          btn.addEventListener("click", e => { e.stopPropagation(); openApptModal(); });
          el.parentNode.insertBefore(btn, el.nextSibling);
        }
      });
    }
    function openApptModal(prefill){
      $("#apptDate").value = (prefill && prefill.date) || "";
      $("#apptTime").value = (prefill && prefill.time) || "";
      $("#apptNotes").value = (prefill && prefill.notes) || "";
      renderApptList();
      $("#apptModal").style.display="flex";
    }
    function closeApptModal(){ $("#apptModal").style.display="none"; }
    $("#apptCloseBtn")?.addEventListener("click", closeApptModal);
    $("#apptModal")?.addEventListener("click", e => { if(e.target === $("#apptModal")) closeApptModal(); });

    function parseInputToDateTime(dateStr,timeStr){
      if(!dateStr) return null;
      const p = dateStr.split("-"); if(p.length<3) return null;
      const yr=+p[0], mo=(+p[1])-1, dy=+p[2];
      let hr=0, mi=0;
      if(timeStr){ const tp=timeStr.split(":"); if(tp.length>=2){ hr=+tp[0]||0; mi=+tp[1]||0; } }
      return new Date(yr,mo,dy,hr,mi,0);
    }
    const pad = n => (n<10?"0":"")+n;
    function toICSDate(dt){
      return dt.getUTCFullYear()+""+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+"T"+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+pad(dt.getUTCSeconds())+"Z";
    }
    function buildIcs(a){
      const dt = parseInputToDateTime(a.date,a.time) || new Date();
      const dtEnd = new Date(dt.getTime()+60*60*1000);
      const summary = "Medical Appointment";
      const desc = a.notes ? a.notes : "NES appointment";
      const ics = [
        "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//NES Checklist//Appointments//EN",
        "BEGIN:VEVENT",
        "DTSTAMP:"+toICSDate(new Date()),
        "DTSTART:"+toICSDate(dt),
        "DTEND:"+toICSDate(dtEnd),
        "SUMMARY:"+summary,
        "DESCRIPTION:"+desc.replace(/\n/g,"\\n"),
        "END:VEVENT","END:VCALENDAR"
      ].join("\r\n");
      return ics;
    }
    function downloadIcs(a){
      const ics = buildIcs(a);
      const blob = new Blob([ics], {type:"text/calendar"});
      const url = URL.createObjectURL(blob);
      const at = document.createElement("a"); at.href=url; at.download="NES_Medical_Appt.ics";
      document.body.appendChild(at); at.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); at.remove(); }, 0);
    }
    function openDeviceCalendar(a){
      const ics = buildIcs(a);
      try{
        const blob = new Blob([ics],{type:"text/calendar"});
        const url = URL.createObjectURL(blob);
        const w = window.open(url,"_blank");
        if(!w){
          const at = document.createElement("a"); at.href=url; at.download="NES_Medical_Appt.ics";
          document.body.appendChild(at); at.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); at.remove(); }, 0);
        }else{
          setTimeout(()=>URL.revokeObjectURL(url), 4000);
        }
      }catch(e){
        downloadIcs(a);
      }
    }
    function renderApptList(){
      const ul = $("#apptList"); if(!ul) return;
      const list = loadAppts(); ul.innerHTML="";
      if(!list.length){
        const li = document.createElement("li"); li.textContent="No appointments saved yet."; li.style.color="#555"; ul.appendChild(li); return;
      }
      list.forEach((a,idx)=>{
        const li = document.createElement("li");
        li.style.border="1px solid var(--line)"; li.style.borderRadius="8px"; li.style.padding="8px";
        const row = document.createElement("div"); row.style.display="flex"; row.style.justifyContent="space-between"; row.style.alignItems="center"; row.style.gap="10px";
        const left = document.createElement("div"); left.innerHTML = "<strong>"+(a.date||"")+"</strong> "+(a.time||"")+(a.notes?(" — "+a.notes):"");
        const right = document.createElement("div");
        function mkBtn(txt,cb){ const b=document.createElement("button"); b.className="btn"; b.style.marginLeft="6px"; b.textContent=txt; b.onclick=cb; return b; }
        right.appendChild(mkBtn("ICS", ()=>downloadIcs(a)));
        right.appendChild(mkBtn("Calendar", ()=>openDeviceCalendar(a)));
        right.appendChild(mkBtn("Delete", ()=>{ const list=loadAppts(); list.splice(idx,1); saveAppts(list); renderApptList(); }));
        row.appendChild(left); row.appendChild(right); li.appendChild(row); ul.appendChild(li);
      });
    }
    function saveCurrentApptFromInputs(){
      const date = ($("#apptDate")?.value||"").trim();
      const time = ($("#apptTime")?.value||"").trim();
      const notes = ($("#apptNotes")?.value||"").trim();
      if(!date){ alert("Please choose a date"); return; }
      const list = loadAppts(); list.push({date,time,notes}); saveAppts(list); renderApptList(); alert("Appointment saved.");
    }
    $("#apptSaveBtn")?.addEventListener("click", saveCurrentApptFromInputs);
    $("#apptIcsBtn")?.addEventListener("click", ()=>{
      const a = {date:($("#apptDate")?.value||""), time:($("#apptTime")?.value||""), notes:($("#apptNotes")?.value||"")};
      if(!a.date){ alert("Pick a date first"); return; } downloadIcs(a);
    });
    $("#apptDeviceCalBtn")?.addEventListener("click", ()=>{
      const a = {date:($("#apptDate")?.value||""), time:($("#apptTime")?.value||""), notes:($("#apptNotes")?.value||"")};
      if(!a.date){ alert("Pick a date first"); return; } openDeviceCalendar(a);
    });

    // ===== Boot =====
    document.addEventListener("DOMContentLoaded", () => {
      renderCustom();
      restoreChecks();
      wireChecks();
      ensureApptButton();
    });
    // Re-run placement if the sheet changes
    document.addEventListener("change", (e)=>{
      const t = e.target || e.srcElement;
      if(t && t.id==="sheetSelect"){
        renderCustom();
        restoreChecks();
        wireChecks();
        ensureApptButton();
      }
    }, true);
  </script>
</body>
</html>
