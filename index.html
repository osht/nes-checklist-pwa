<!DOCTYPE html>
<html lang="en">
<head>
<!-- NES Checklist PWA internal version: v31-clean-fix | built 2025-10-12T01:33:11.961977Z | based on v19.1 hotfix -->


<script>
(function(){
  try {
    if (!localStorage.getItem('nes_sw_killed')) {
      )).then(function(){
            localStorage.setItem('nes_sw_killed', '1');
            // small delay before reload to ensure unregister settles
            setTimeout(function(){ location.reload(true); }, 300);
          });
        });
      }
    }
  } catch(e) {}
})();
</script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NES — Manager Notes Checklist (v17)</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<meta name="theme-color" content="#003366" />
<style>
  :root { --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; --bg:#ffffff; --text:#222; --muted:#666; --line:#AAA; --danger:#b00020;
           --btn-primary-bg:#003366; --btn-primary-border:#003366; --btn-secondary-bg:#f5f5f5; --btn-secondary-border:#ddd; --btn-danger-bg:#ffe7ea; --btn-danger-border:#ffcbd2; }
  * { box-sizing:border-box; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: var(--font); }
  .container { max-width: 960px; margin: 28px auto 60px; padding: 0 24px; }
  header { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:10px; }
  header .brand-logo { max-width:320px; width:clamp(200px,40vw,320px); height:auto; object-fit:contain; background:#fff; padding:8px; border-radius:10px; box-shadow: 0 0 0 4px #fff, 0 3px 10px rgba(0,0,0,.08); }
  header h1 { font-size:24px; margin:0; font-weight:800; letter-spacing:.2px; }
  .topbar { display:flex; flex-wrap:wrap; gap:12px 16px; align-items:center; justify-content:space-between; margin:8px 0 18px; padding:10px 0; border-top:1px solid var(--line); border-bottom:1px solid var(--line); }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  label { font-weight:700; margin-right:6px; }
  input[type="date"], select { padding:6px 8px; border:1px solid var(--line); border-radius:4px; background:#fff; color: var(--text); }
  .btn { border-radius:6px; padding:10px 14px; font-weight:800; cursor:pointer; letter-spacing:.2px; border:1px solid transparent; }
  .btn-primary { background: var(--btn-primary-bg); color:#fff; border-color: var(--btn-primary-border); }
  .btn-secondary { background: var(--btn-secondary-bg); color:#333; border-color: var(--btn-secondary-border); }
  .btn-danger { background: var(--btn-danger-bg); color:#b00020; border-color: var(--btn-danger-border); }
  .btn:active { transform: translateY(1px); }
  .save-status { font-size:12px; color: var(--muted); padding:6px 10px; border:1px solid var(--line); border-radius:20px; }
  .section { margin-top:16px; }
  .section-title { font-size:16px; font-weight:800; color:#333; margin:18px 0 8px; }
  ul.checklist { list-style:none; padding:0; margin:0; border-top:1px solid var(--line); min-height:10px; }
  li.item { display:flex; align-items:center; gap:8px; padding:10px 0; border-bottom:1px solid var(--line); }
  li.item input[type="checkbox"] { width:16px; height:16px; flex:0 0 auto; }
  li.item .num { width:28px; text-align:right; color:var(--muted); font-weight:700; padding-right:4px; }
  li.item .label { flex:1 1 auto; outline:none; cursor:pointer; }
  li.item .del { flex:0 0 auto; background:#fff; border:1px solid var(--btn-danger-border); border-radius:6px; padding:4px 8px; font-weight:800; color:var(--danger); cursor:pointer; }
  li.item .del:hover { border-color:#e0a0a8; background:#fff5f6; }
  .placeholder { height:2px; background:var(--btn-primary-bg); margin:-1px 0; }
  @media print { .topbar, .del, #addRowBtn, #toggleLinksBtn, #usefulLinks { display:none !important; } .container { margin:0; max-width:none; } }

  #instrModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }
  #instrModal .card { background:var(--bg); color:var(--text); max-width:720px; width:92%; border:1px solid var(--line); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  #instrModal .card-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); }
  #instrModal .card-body { padding:16px; white-space:pre-wrap; line-height:1.5; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <img src="1000007845.jpg" alt="NES Logo" class="brand-logo" />
      <h1>Manager Notes Checklist</h1>
    </header>

    <div class="topbar">
      <div class="row">
        <label for="checklistDate">Date:</label>
        <input type="date" id="checklistDate" value="2025-10-11" />
        <label for="sheetSelect">Sheet:</label>
        <select id="sheetSelect" title="Choose a sheet"></select>
        <button class="btn btn-secondary" id="newSheetBtn">New</button>
        <button class="btn btn-secondary" id="renameSheetBtn">Rename</button>
        <button class="btn btn-danger" id="deleteSheetBtn">Delete</button>
      </div>
      <div class="row">
        <span id="saveStatus" class="save-status">Auto-save ready</span>
        <label for="presetSelect">Theme Preset:</label>
        <select id="presetSelect" title="Choose a preset theme"></select>
        <label for="fontSelect">Font:</label>
        <select id="fontSelect" title="Choose a font"></select>
        <button class="btn btn-secondary" id="manageSmsBtn" title="Manage SMS recipients">SMS Recipients</button>
        <button class="btn btn-primary" id="printBtn">Print / Save as PDF</button>
      </div>
    </div>

    <div class="section" id="section-1st"><div class="section-title">1st of Month</div><ul class="checklist" id="list-1st"></ul></div>
    <div class="section" id="section-before5th"><div class="section-title">Before the 5th</div><ul class="checklist" id="list-before5th"></ul></div>
    <div class="section" id="section-monthly"><div class="section-title">Monthly</div><ul class="checklist" id="list-monthly"></ul></div>
    <div class="section" id="section-biweekly"><div class="section-title">Bi-Weekly</div><ul class="checklist" id="list-biweekly"></ul></div>
    <div class="section" id="section-daily"><div class="section-title">Daily</div><ul class="checklist" id="list-daily"></ul></div>

    <div class="section" id="section-custom">
      <div class="section-title">Custom Items (Movable between sections)</div>
      <ul class="checklist" id="list-custom"></ul>
      <div style="display:flex;justify-content:center;margin-top:10px;">
        <button class="btn btn-primary" id="addRowBtn">+ Add Row</button>
      </div>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instrModal">
    <div class="card">
      <div class="card-head">
        <div id="instrTitle" style="font-weight:800;font-size:16px;">Task Instructions</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="editInstrBtn" class="btn btn-secondary" title="Add or edit instructions">Add / Edit</button>
          <button id="closeInstrBtn" class="btn btn-danger" title="Close">Close</button>
        </div>
      </div>
      <div class="card-body" id="instrBody"></div>
    </div>
  </div>

  <!-- SMS Recipients Modal -->
  <div id="smsModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999;">
    <div style="background:var(--bg);color:var(--text);max-width:520px;width:92%;border:1px solid var(--line);border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);">
        <div style="font-weight:800;font-size:16px;">SMS Recipients (per sheet)</div>
        <button id="smsCloseBtn" class="btn btn-danger">Close</button>
      </div>
      <div style="padding:16px;display:flex;flex-direction:column;gap:10px;">
        <label for="smsNumbersInput" style="font-weight:700;">Phone numbers (comma separated):</label>
        <input id="smsNumbersInput" type="text" placeholder="+15551234567, +15557654321" style="padding:8px;border:1px solid var(--line);border-radius:6px;"/>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button id="smsSaveBtn" class="btn btn-primary">Save</button>
        </div>
        <div style="font-size:12px;color:var(--muted);">These numbers are stored only in your browser for this sheet. Sending uses your device’s Messages app.</div>
      </div>
    </div>
  </div>

  <!-- Useful Links Toggle & Section -->
  <div style="margin: 24px;">
    <button id="toggleLinksBtn" class="btn btn-secondary" style="margin-bottom:10px;">
      Show Useful Links
    </button>

    <section id="usefulLinks" style="display:none; border-top: 2px solid var(--line); padding-top: 16px;">
      <h2 style="font-size:1.2rem; font-weight:700; margin:0 0 12px;">Useful Links</h2>
      <div style="display:flex; flex-wrap:wrap; gap:12px;">

        <!-- Primary actions -->
        <a href="https://secure.therapservices.net/ma/isp/ispDataSearch?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">ISP Search</a>
        <a href="https://secure.therapservices.net/ma/mar/marDataSearch?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">MAR Search</a>
        <a href="https://secure.therapservices.net/ma/tlog/programList?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">New Tlog</a>
        <a href="https://secure.therapservices.net/ma/ger/programList?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">GER</a>
        <a href="https://secure.therapservices.net/ma/hlth/appointments/individualList" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">New Appt</a>
        <a href="https://secure.therapservices.net/ma/hlth/appSearch" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">Search Appt</a>
        <a href="https://secure.therapservices.net/ma/hlth/appointment/calendar?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">Appt Calendar</a>

        <!-- Secondary tools -->
        <a href="https://webtime2.paylocity.com/webtime/v3/schedule" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">House Schedule</a>
        
        
        
        
        <a href="https://calendar.google.com/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">Staff Calendar</a>
        

      </div>
    </section>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const SHEETS_KEY='nes_manager_checklist_sheets_v1';
  const STORAGE_PREFIX='nes_manager_checklist_sheet_';
  const THEME_PREFIX='nes_manager_checklist_theme_';
  const THEME_PRESET_PREFIX='nes_manager_checklist_theme_preset_';
  const FONT_KEY_PREFIX='nes_manager_checklist_font_';
  const INSTR_PREFIX='nes_manager_checklist_instructions_';
  const SMS_PREFIX='nes_manager_checklist_sms_';
  const LINKS_VIS_PREFIX='nes_manager_checklist_links_visible_';
  const DEFAULT_SHEET='Default';
  const lists=['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'];
  const keyFor=(p,n)=>p+n;

  // Theme & font (simple, stable)
  function defaultTheme(){ return {font:'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif',bg:'#ffffff',text:'#222',line:'#AAA',btnPrimaryBg:'#003366',btnPrimaryBorder:'#003366',btnSecondaryBg:'#f5f5f5',btnSecondaryBorder:'#ddd',btnDangerBg:'#ffe7ea',btnDangerBorder:'#ffcbd2'}; }
  function applyTheme(t){
    const r=document.documentElement;
    if(t.font) r.style.setProperty('--font',t.font);
    r.style.setProperty('--bg',t.bg); r.style.setProperty('--text',t.text); r.style.setProperty('--line',t.line);
    r.style.setProperty('--btn-primary-bg',t.btnPrimaryBg); r.style.setProperty('--btn-primary-border',t.btnPrimaryBorder);
    r.style.setProperty('--btn-secondary-bg',t.btnSecondaryBg); r.style.setProperty('--btn-secondary-border',t.btnSecondaryBorder);
    r.style.setProperty('--btn-danger-bg',t.btnDangerBg); r.style.setProperty('--btn-danger-border',t.btnDangerBorder);
  }
  function saveTheme(t){ try{ localStorage.setItem(keyFor(THEME_PREFIX,currentSheet()), JSON.stringify(t)); }catch(e){} applyTheme(t); }
  function loadTheme(){
    let t=defaultTheme(); try{ const raw=localStorage.getItem(keyFor(THEME_PREFIX,currentSheet())); if(raw) t=Object.assign(t, JSON.parse(raw)); }catch(e){}
    applyTheme(t);
  }

  const presetSelect=document.getElementById('presetSelect');
  const fontSelect=document.getElementById('fontSelect');
  function loadPresetOptions(){
    const opts=[
  // ---- Business (6) ----
  { id:'biz-min', name:'Business — Minimal', t:{bg:'#ffffff',text:'#334155',line:'#cbd5e1',btnPrimaryBg:'#334155',btnPrimaryBorder:'#334155',btnSecondaryBg:'#f8fafc',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'biz-navy', name:'Business — Navy', t:{bg:'#ffffff',text:'#1f2937',line:'#e5e7eb',btnPrimaryBg:'#0b3d91',btnPrimaryBorder:'#0b3d91',btnSecondaryBg:'#f3f4f6',btnSecondaryBorder:'#e5e7eb',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'biz-exec', name:'Business — Executive', t:{bg:'#ffffff',text:'#111827',line:'#e5e7eb',btnPrimaryBg:'#0f766e',btnPrimaryBorder:'#0f766e',btnSecondaryBg:'#f9fafb',btnSecondaryBorder:'#e5e7eb',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
  { id:'biz-slate', name:'Business — Slate', t:{bg:'#f8fafc',text:'#0f172a',line:'#e2e8f0',btnPrimaryBg:'#0f172a',btnPrimaryBorder:'#0f172a',btnSecondaryBg:'#f1f5f9',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'biz-emerald', name:'Business — Emerald', t:{bg:'#ffffff',text:'#0f172a',line:'#e5e7eb',btnPrimaryBg:'#065f46',btnPrimaryBorder:'#065f46',btnSecondaryBg:'#ecfdf5',btnSecondaryBorder:'#d1fae5',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'biz-maroon', name:'Business — Maroon', t:{bg:'#ffffff',text:'#1f2937',line:'#e5e7eb',btnPrimaryBg:'#7f1d1d',btnPrimaryBorder:'#7f1d1d',btnSecondaryBg:'#faf5f5',btnSecondaryBorder:'#fde2e2',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },

  // ---- Cute (6) ----
  { id:'cute-blossom', name:'Cute — Blossom', t:{bg:'#fff7fb',text:'#5b2245',line:'#f3cfe1',btnPrimaryBg:'#ec4899',btnPrimaryBorder:'#ec4899',btnSecondaryBg:'#fde5f1',btnSecondaryBorder:'#f3cfe1',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
  { id:'cute-lavender', name:'Cute — Lavender', t:{bg:'#faf5ff',text:'#4c1d95',line:'#e9d5ff',btnPrimaryBg:'#7c3aed',btnPrimaryBorder:'#7c3aed',btnSecondaryBg:'#f3e8ff',btnSecondaryBorder:'#e9d5ff',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },
  { id:'cute-mint', name:'Cute — Mint', t:{bg:'#f0fff4',text:'#065f46',line:'#a7f3d0',btnPrimaryBg:'#10b981',btnPrimaryBorder:'#10b981',btnSecondaryBg:'#d1fae5',btnSecondaryBorder:'#a7f3d0',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },
  { id:'cute-sky', name:'Cute — Sky', t:{bg:'#eff6ff',text:'#1e40af',line:'#bfdbfe',btnPrimaryBg:'#3b82f6',btnPrimaryBorder:'#3b82f6',btnSecondaryBg:'#dbeafe',btnSecondaryBorder:'#bfdbfe',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
  { id:'cute-peach', name:'Cute — Peach', t:{bg:'#fff7ed',text:'#7c2d12',line:'#fed7aa',btnPrimaryBg:'#f97316',btnPrimaryBorder:'#f97316',btnSecondaryBg:'#ffedd5',btnSecondaryBorder:'#fed7aa',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
  { id:'cute-lemon', name:'Cute — Lemon', t:{bg:'#fefce8',text:'#713f12',line:'#fde68a',btnPrimaryBg:'#eab308',btnPrimaryBorder:'#eab308',btnSecondaryBg:'#fef9c3',btnSecondaryBorder:'#fde68a',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },

  // ---- Color (6) ----
  { id:'color-ocean', name:'Color — Ocean', t:{bg:'#f0f9ff',text:'#0c4a6e',line:'#bae6fd',btnPrimaryBg:'#0369a1',btnPrimaryBorder:'#0369a1',btnSecondaryBg:'#e0f2fe',btnSecondaryBorder:'#bae6fd',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'color-forest', name:'Color — Forest', t:{bg:'#f7fee7',text:'#14532d',line:'#d9f99d',btnPrimaryBg:'#15803d',btnPrimaryBorder:'#15803d',btnSecondaryBg:'#ecfccb',btnSecondaryBorder:'#d9f99d',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'color-sunset', name:'Color — Sunset', t:{bg:'#fff7ed',text:'#7c2d12',line:'#fed7aa',btnPrimaryBg:'#ea580c',btnPrimaryBorder:'#ea580c',btnSecondaryBg:'#ffedd5',btnSecondaryBorder:'#fed7aa',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'color-rose', name:'Color — Rose', t:{bg:'#fff1f2',text:'#881337',line:'#fecdd3',btnPrimaryBg:'#e11d48',btnPrimaryBorder:'#e11d48',btnSecondaryBg:'#ffe4e6',btnSecondaryBorder:'#fecdd3',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'color-plum', name:'Color — Plum', t:{bg:'#faf5ff',text:'#3b0764',line:'#e9d5ff',btnPrimaryBg:'#6d28d9',btnPrimaryBorder:'#6d28d9',btnSecondaryBg:'#f3e8ff',btnSecondaryBorder:'#e9d5ff',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
  { id:'color-slate', name:'Color — Slate', t:{bg:'#f8fafc',text:'#0f172a',line:'#e2e8f0',btnPrimaryBg:'#0f172a',btnPrimaryBorder:'#0f172a',btnSecondaryBg:'#f1f5f9',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} }
];
    presetSelect.innerHTML=''; opts.forEach(p=>{ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; presetSelect.appendChild(o); });
    presetSelect.addEventListener('change',()=>{ const f=opts.find(x=>x.id===presetSelect.value); if(f && f.t){ saveTheme(Object.assign(defaultTheme(), f.t)); } });
  }
  function loadFontOptions(){
    const fonts=[
      {id:'system', name:'System Sans', css:'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif'},
      {id:'inter', name:'Inter', css:'Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif'},
      {id:'georgia', name:'Georgia', css:'Georgia, Cambria, serif'}
    ];
    fontSelect.innerHTML='';
    fonts.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name; fontSelect.appendChild(o); });
    function applyFont(id){ const f=fonts.find(x=>x.id===id)||fonts[0]; document.documentElement.style.setProperty('--font', f.css); }
    const fontKey=keyFor(FONT_KEY_PREFIX,currentSheet());
    try{ const saved=localStorage.getItem(fontKey); if(saved) applyFont(saved);}catch(e){}
    fontSelect.addEventListener('change', ()=>{ applyFont(fontSelect.value); try{ localStorage.setItem(fontKey, fontSelect.value); }catch(e){} });
  }

  // Sheets
  const sheetSelect=document.getElementById('sheetSelect');
  function getSheets(){ try{const t=localStorage.getItem(SHEETS_KEY); return t?JSON.parse(t):[DEFAULT_SHEET];}catch(e){return [DEFAULT_SHEET];} }
  function saveSheets(a){ try{localStorage.setItem(SHEETS_KEY,JSON.stringify(a));}catch(e){} }
  function currentSheet(){ return sheetSelect.value||DEFAULT_SHEET; }
  function refreshSheets(){ const names=getSheets(); sheetSelect.innerHTML=''; names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sheetSelect.appendChild(o); }); }
  function ensureDefault(){ const names=getSheets(); if(!names.includes(DEFAULT_SHEET)){ names.unshift(DEFAULT_SHEET); saveSheets(names);}}

  // State
  function stateKey(){ return keyFor(STORAGE_PREFIX,currentSheet()); }
  function collectState(){
    const sections={};
    ['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'].forEach(id=>{
      const ul=document.getElementById(id);
      sections[id]=Array.from(ul.querySelectorAll('li.item')).map(li=>({label:(li.querySelector('.label')?.textContent)||'', checked:(li.querySelector('input[type="checkbox"]').checked)||false}));
    });
    return { date: document.getElementById('checklistDate').value, sections };
  }
  function applyState(s){
    if(!s) return;
    if(s.date) document.getElementById('checklistDate').value=s.date;
    ['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'].forEach(id=>{
      const ul=document.getElementById(id); ul.innerHTML='';
      (s.sections?.[id]||[]).forEach(it=>{ const li=mkItem(it.label, id==='list-custom'); li.querySelector('input[type="checkbox"]').checked=!!it.checked; ul.appendChild(li); });
    });
    renumberCustom(); ensureTimesheetSmsButton();
  }
  function saveState(){ try{ localStorage.setItem(stateKey(), JSON.stringify(collectState())); setStatus('Saved'); }catch(e){ setStatus('Save error'); } }
  function loadState(){ try{ const raw=localStorage.getItem(stateKey()); if(raw) applyState(JSON.parse(raw)); else initDefaults(); }catch(e){ initDefaults(); } }
  function setStatus(msg){ document.getElementById('saveStatus').textContent = msg + ' • ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

  function mkItem(label, withNumber){
    const li=document.createElement('li'); li.className='item'; li.setAttribute('draggable','true');
    li.innerHTML = withNumber ? '<input type="checkbox"/><div class="num"></div><div class="label" contenteditable="true"></div><button class="del" title="Remove">×</button>'
                              : '<input type="checkbox"/><div class="label"></div><button class="del" title="Remove">×</button>';
    li.querySelector('.label').textContent = label || '';
    return li;
  }
  function initDefaults(){
    const defaults={
      'list-1st':[ 'Client Medical Assessment Form','RHS Absentee Form','House Sign-in Sheet','Fire Drill / Natural Disaster Drill','PRN Start Count' ],
      'list-before5th':[ 'Monthly summaries and monthly appointment','Emails to Support Coordinator' ],
      'list-monthly':[ 'House Meeting Notes (Due in Ben office after meeting)','Manager Meeting','Financials' ],
      'list-biweekly':[ 'Timesheets / Absentee Sheet','Check in Times for Accuracy' ],
      'list-daily':[ 'Check MARs and notes of your staff' ],
      'list-custom':[ 'Custom item 1','Custom item 2','Custom item 3' ]
    };
    ['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'].forEach(id=>{
      const ul=document.getElementById(id); ul.innerHTML='';
      defaults[id].forEach(lbl=>{ ul.appendChild(mkItem(lbl, id==='list-custom')); });
    });
    renumberCustom(); saveState();
  }

  // Drag & drop
  let dragEl=null; let placeholder=document.createElement('div'); placeholder.className='placeholder';
  function getAfter(ul, y){
    const els=[...ul.querySelectorAll('li.item:not(.dragging)')];
    return els.reduce((closest,child)=>{
      const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2;
      return (offset<0 && offset>closest.offset)? {offset,element:child} : closest;
    }, {offset:-Infinity, element:null}).element;
  }
  document.addEventListener('dragstart', e=>{ const li=e.target.closest('li.item'); if(!li) return; dragEl=li; li.classList.add('dragging'); });
  document.addEventListener('dragend', e=>{ if(!dragEl) return; dragEl.classList.remove('dragging'); dragEl=null; placeholder.remove(); renumberCustom(); saveState(); });
  document.querySelectorAll('ul.checklist').forEach(ul=>{
    ul.addEventListener('dragover', e=>{ e.preventDefault(); const after=getAfter(ul, e.clientY); if(!after) ul.appendChild(placeholder); else ul.insertBefore(placeholder, after); });
    ul.addEventListener('drop', e=>{ e.preventDefault(); if(!dragEl) return; ul.insertBefore(dragEl, placeholder); placeholder.remove(); });
  });
  function renumberCustom(){ const rows=document.querySelectorAll('#list-custom li.item'); let i=1; rows.forEach(li=>{ let n=li.querySelector('.num'); if(!n){ n=document.createElement('div'); n.className='num'; li.insertBefore(n, li.querySelector('.label')); } n.textContent=(i++)+'.'; }); }

  // Delete & add
  document.addEventListener('click', e=>{ const del=e.target.closest('.del'); if(del){ const li=del.closest('li.item'); li.remove(); renumberCustom(); saveState(); } });
  document.getElementById('addRowBtn').addEventListener('click', ()=>{ const ul=document.getElementById('list-custom'); ul.appendChild(mkItem('New custom item', true)); renumberCustom(); saveState(); });
  document.getElementById('printBtn').addEventListener('click', ()=>window.print());

  // Sheets UI
  function refreshSheets(){ const names=getSheets(); sheetSelect.innerHTML=''; names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sheetSelect.appendChild(o); }); }
  function ensureDefault(){ const names=getSheets(); if(!names.includes(DEFAULT_SHEET)){ names.unshift(DEFAULT_SHEET); saveSheets(names);}}
  ensureDefault(); refreshSheets(); sheetSelect.value=getSheets()[0]||DEFAULT_SHEET;
  sheetSelect.addEventListener('change', ()=>{ loadState(); loadTheme(); loadLinksVisible(); });

  document.getElementById('newSheetBtn').addEventListener('click', ()=>{ const name=(prompt('Sheet name:', 'New Sheet')||'').trim(); if(!name) return; const names=getSheets(); if(names.includes(name)) return alert('Name exists'); names.push(name); saveSheets(names); refreshSheets(); sheetSelect.value=name; initDefaults(); loadLinksVisible(); });
  document.getElementById('renameSheetBtn').addEventListener('click', ()=>{
    const old=sheetSelect.value||DEFAULT_SHEET; if(old===DEFAULT_SHEET) return alert('Default cannot be renamed');
    const name=(prompt('New name:', old)||'').trim(); if(!name) return; const names=getSheets(); if(names.includes(name)) return alert('Name exists');
    const idx=names.indexOf(old); names[idx]=name; saveSheets(names);
    localStorage.setItem(keyFor(STORAGE_PREFIX,name), localStorage.getItem(keyFor(STORAGE_PREFIX,old)));
    localStorage.setItem(keyFor(THEME_PREFIX,name), localStorage.getItem(keyFor(THEME_PREFIX,old)));
    localStorage.setItem(keyFor(THEME_PRESET_PREFIX,name), localStorage.getItem(keyFor(THEME_PRESET_PREFIX,old)));
    localStorage.setItem(keyFor(FONT_KEY_PREFIX,name), localStorage.getItem(keyFor(FONT_KEY_PREFIX,old)));
    localStorage.setItem(keyFor(INSTR_PREFIX,name), localStorage.getItem(keyFor(INSTR_PREFIX,old)));
    localStorage.setItem(keyFor(SMS_PREFIX,name), localStorage.getItem(keyFor(SMS_PREFIX,old)));
    localStorage.setItem(keyFor(LINKS_VIS_PREFIX,name), localStorage.getItem(keyFor(LINKS_VIS_PREFIX,old)));
    localStorage.removeItem(keyFor(STORAGE_PREFIX,old)); localStorage.removeItem(keyFor(THEME_PREFIX,old)); localStorage.removeItem(keyFor(THEME_PRESET_PREFIX,old)); localStorage.removeItem(keyFor(FONT_KEY_PREFIX,old)); localStorage.removeItem(keyFor(INSTR_PREFIX,old)); localStorage.removeItem(keyFor(SMS_PREFIX,old)); localStorage.removeItem(keyFor(LINKS_VIS_PREFIX,old));
    refreshSheets(); sheetSelect.value=name; loadState(); loadTheme(); loadLinksVisible();
  });
  document.getElementById('deleteSheetBtn').addEventListener('click', ()=>{
    const name=sheetSelect.value||DEFAULT_SHEET; if(name===DEFAULT_SHEET) return alert('Default cannot be deleted'); if(!confirm('Delete sheet \"'+name+'\"?')) return;
    const names=getSheets().filter(n=>n!==name); saveSheets(names);
    localStorage.removeItem(keyFor(STORAGE_PREFIX,name)); localStorage.removeItem(keyFor(THEME_PREFIX,name)); localStorage.removeItem(keyFor(THEME_PRESET_PREFIX,name)); localStorage.removeItem(keyFor(FONT_KEY_PREFIX,name)); localStorage.removeItem(keyFor(INSTR_PREFIX,name)); localStorage.removeItem(keyFor(SMS_PREFIX,name)); localStorage.removeItem(keyFor(LINKS_VIS_PREFIX,name));
    refreshSheets(); sheetSelect.value=names[0]||DEFAULT_SHEET; loadState(); loadTheme(); loadLinksVisible();
  });

  // Instructions modal
  const instrModal=document.getElementById('instrModal');
  const instrTitle=document.getElementById('instrTitle');
  const instrBody=document.getElementById('instrBody');
  const closeInstrBtn=document.getElementById('closeInstrBtn');
  const editInstrBtn=document.getElementById('editInstrBtn');
  const instrKeyFn=()=> keyFor(INSTR_PREFIX, currentSheet());
  function getInstrMap(){ try{ const raw=localStorage.getItem(instrKeyFn()); return raw?JSON.parse(raw):{}; }catch(e){ return {}; } }
  function saveInstrMap(map){ try{ localStorage.setItem(instrKeyFn(), JSON.stringify(map)); }catch(e){} }
  let currentTaskKey=null;
  function openInstr(titleText){ currentTaskKey=(titleText||'').trim(); const map=getInstrMap(); const txt=map[currentTaskKey] || 'No instructions available yet.'; instrTitle.textContent=currentTaskKey || 'Task Instructions'; instrBody.textContent=txt; instrModal.style.display='flex'; }
  function closeInstr(){ instrModal.style.display='none'; }
  closeInstrBtn.addEventListener('click', closeInstr);
  instrModal.addEventListener('click', (e)=>{ if(e.target===instrModal) closeInstr(); });
  editInstrBtn.addEventListener('click', ()=>{ if(!currentTaskKey) return; const map=getInstrMap(); const prev=map[currentTaskKey]||''; const next=prompt('Instructions for: '+currentTaskKey, prev); if(next===null) return; map[currentTaskKey]=next.trim(); saveInstrMap(map); instrBody.textContent=map[currentTaskKey]||'No instructions available yet.'; });
  document.addEventListener('click', (e)=>{ const lbl=e.target.closest('.label'); if(!lbl) return; const titleText=lbl.textContent||''; if(titleText.trim().length===0) return; openInstr(titleText); });

  // SMS
  function smsKey(){ return keyFor(SMS_PREFIX,currentSheet()); }
  function getSmsRecipients(){ try{ const raw=localStorage.getItem(smsKey()); return raw?JSON.parse(raw):[]; }catch(e){ return []; } }
  function setSmsRecipients(arr){ try{ localStorage.setItem(smsKey(), JSON.stringify(arr)); }catch(e){} }
  function platformIsIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
  function buildSmsUrl(number, body){ const enc=encodeURIComponent(body); if(platformIsIOS()) return 'sms:'+encodeURIComponent(number)+'&body='+enc; return 'sms:'+encodeURIComponent(number)+'?body='+enc; }
  function sendTimesheetCompleted(){
  var number = '4356509426';
  var body = 'Timesheet is completed and ready for you.';
  var enc = encodeURIComponent(body);
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  var url = isIOS ? ('sms:' + number + '&body=' + enc) : ('sms:' + number + '?body=' + enc);
  window.location.href = url;
}
 
  function ensureTimesheetSmsButton(){ const ul=document.getElementById('list-biweekly'); if(!ul) return; [...ul.querySelectorAll('li.item')].forEach(li=>{ const lbl=li.querySelector('.label'); if(!lbl) return; const text=(lbl.textContent||'').toLowerCase(); if(text.includes('timesheets')){ if(li.querySelector('.sms-action')) return; const btn=document.createElement('button'); btn.className='btn btn-secondary sms-action'; btn.textContent='Text Timesheet Completed'; btn.style.marginLeft='8px'; btn.addEventListener('click',(e)=>{ e.stopPropagation(); sendTimesheetCompleted(); }); li.appendChild(btn); } }); }
  
  
  
  document.addEventListener('input', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('label')) ensureTimesheetSmsButton(); });

  // Useful Links visibility (per sheet)
  function linksKey(){ return keyFor(LINKS_VIS_PREFIX,currentSheet()); }
  function setLinksVisible(visible){ const sec=document.getElementById('usefulLinks'); const btn=document.getElementById('toggleLinksBtn'); if(!sec||!btn) return; sec.style.display = visible ? 'block' : 'none'; btn.textContent = visible ? 'Hide Useful Links' : 'Show Useful Links'; try{ localStorage.setItem(linksKey(), JSON.stringify(!!visible)); }catch(e){} }
  function loadLinksVisible(){ let v=false; try{ const raw=localStorage.getItem(linksKey()); if(raw!==null) v = JSON.parse(raw)===true; }catch(e){} setLinksVisible(v); }
  document.getElementById('toggleLinksBtn')?.addEventListener('click', ()=>{ const sec=document.getElementById('usefulLinks'); setLinksVisible(!(sec && sec.style.display!=='none')); });

  // Auto-save (debounced)
  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this, arguments), ms); }; }
  const debouncedSave = debounce(saveState, 250);
  document.getElementById('checklistDate').addEventListener('change', debouncedSave);
  document.addEventListener('change', (e)=>{ if(e.target && e.target.matches('ul.checklist input[type="checkbox"]')) debouncedSave(); });
  document.addEventListener('input', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('label')) debouncedSave(); });
  document.getElementById('addRowBtn').addEventListener('click', debouncedSave);
  document.addEventListener('click', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('del')) debouncedSave(); });
  document.addEventListener('dragend', debouncedSave);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveState(); });
  window.addEventListener('beforeunload', ()=>{ try{ saveState(); }catch(e){} });

  // Build helpers and init
  function renumberCustom(){ const rows=document.querySelectorAll('#list-custom li.item'); let i=1; rows.forEach(li=>{ let n=li.querySelector('.num'); if(!n){ n=document.createElement('div'); n.className='num'; li.insertBefore(n, li.querySelector('.label')); } n.textContent=(i++)+'.'; }); }
  function applyDefaults(){ 
    const defs={
      'list-1st':[ 'Client Medical Assessment Form','RHS Absentee Form','House Sign-in Sheet','Fire Drill / Natural Disaster Drill','PRN Start Count' ],
      'list-before5th':[ 'Monthly summaries and monthly appointment','Emails to Support Coordinator' ],
      'list-monthly':[ 'House Meeting Notes (Due in Ben office after meeting)','Manager Meeting','Financials' ],
      'list-biweekly':[ 'Timesheets / Absentee Sheet','Check in Times for Accuracy' ],
      'list-daily':[ 'Check MARs and notes of your staff' ],
      'list-custom':[ 'Custom item 1','Custom item 2','Custom item 3' ]
    };
    ['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'].forEach(id=>{
      const ul=document.getElementById(id); ul.innerHTML=''; defs[id].forEach(lbl=>{ ul.appendChild(mkItem(lbl, id==='list-custom')); });
    });
    renumberCustom();
  }
  function mkItem(label, withNumber){
    const li=document.createElement('li'); li.className='item'; li.setAttribute('draggable','true');
    li.innerHTML = withNumber ? '<input type="checkbox"/><div class="num"></div><div class="label" contenteditable="true"></div><button class="del" title="Remove">×</button>'
                              : '<input type="checkbox"/><div class="label"></div><button class="del" title="Remove">×</button>';
    li.querySelector('.label').textContent = label || '';
    return li;
  }

  function init(){
    ensureDefault(); refreshSheets(); loadTheme();
    try{ const raw=localStorage.getItem(keyFor(STORAGE_PREFIX,currentSheet())); if(raw) applyState(JSON.parse(raw)); else { applyDefaults(); saveState(); } }catch(e){ applyDefaults(); saveState(); }
    loadPresetOptions(); loadFontOptions(); loadLinksVisible(); ensureTimesheetSmsButton();
    setTimeout(()=>{ try{ saveState(); }catch(e){} }, 300);
  }
  init();
});
</script>
</body>
</html>
