<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NES â€” Manager Notes Checklist (v26 ES5)</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<meta name="theme-color" content="#003366" />
<style>
  :root { --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; --font-weight: 400;
           --bg:#ffffff; --text:#222; --muted:#666; --line:#AAA; --danger:#b00020;
           --btn-primary-bg:#003366; --btn-primary-border:#003366; --btn-secondary-bg:#f5f5f5; --btn-secondary-border:#ddd; --btn-danger-bg:#ffe7ea; --btn-danger-border:#ffcbd2; }
  * { box-sizing:border-box; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: var(--font); font-weight: var(--font-weight, 400); }
  .container { max-width: 960px; margin: 28px auto 60px; padding: 0 24px; }
  header { display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:10px; }
  header .brand-logo { max-width:320px; width:clamp(200px,40vw,320px); height:auto; object-fit:contain; background:#fff; padding:8px; border-radius:10px; box-shadow: 0 0 0 4px #fff, 0 3px 10px rgba(0,0,0,.08); }
  header h1 { font-size:24px; margin:0; font-weight:800; letter-spacing:.2px; }
  .topbar { display:flex; flex-wrap:wrap; gap:12px 16px; align-items:center; justify-content:space-between; margin:8px 0 18px; padding:10px 0; border-top:1px solid var(--line); border-bottom:1px solid var(--line); }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  label { font-weight:700; margin-right:6px; }
  input[type="date"], select { padding:6px 8px; border:1px solid var(--line); border-radius:4px; background:#fff; color: var(--text); }
  .btn { border-radius:6px; padding:10px 14px; font-weight:800; cursor:pointer; letter-spacing:.2px; border:1px solid transparent; }
  .btn-primary { background: var(--btn-primary-bg); color:#fff; border-color: var(--btn-primary-border); }
  .btn-secondary { background: var(--btn-secondary-bg); color:#333; border-color: var(--btn-secondary-border); }
  .btn-danger { background: var(--btn-danger-bg); color:#b00020; border-color: var(--btn-danger-border); }
  .btn:active { transform: translateY(1px); }
  .save-status { font-size:12px; color: var(--muted); padding:6px 10px; border:1px solid var(--line); border-radius:20px; }
  .section { margin-top:16px; }
  .section-title { font-size:16px; font-weight:800; color:#333; margin:18px 0 8px; }
  ul.checklist { list-style:none; padding:0; margin:0; border-top:1px solid var(--line); min-height:10px; }
  li.item { display:flex; align-items:center; gap:8px; padding:10px 0; border-bottom:1px solid var(--line); }
  li.item input[type="checkbox"] { width:16px; height:16px; flex:0 0 auto; }
  li.item .num { width:28px; text-align:right; color:var(--muted); font-weight:700; padding-right:4px; }
  li.item .label { flex:1 1 auto; outline:none; cursor:pointer; }
  li.item .del { flex:0 0 auto; background:#fff; border:1px solid var(--btn-danger-border); border-radius:6px; padding:4px 8px; font-weight:800; color:var(--danger); cursor:pointer; }
  li.item .del:hover { border-color:#e0a0a8; background:#fff5f6; }
  .placeholder { height:2px; background:var(--btn-primary-bg); margin:-1px 0; }
  @media print { .topbar, .del, #addRowBtn, #toggleLinksBtn, #usefulLinks { display:none !important; } .container { margin:0; max-width:none; } }

  #instrModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }
  #instrModal .card { background:var(--bg); color:var(--text); max-width:720px; width:92%; border:1px solid var(--line); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  #instrModal .card-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); }
  #instrModal .card-body { padding:16px; white-space:pre-wrap; line-height:1.5; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <img src="1000007845.jpg" alt="NES Logo" class="brand-logo" />
      <h1>Manager Notes Checklist</h1>
    </header>

    <div class="topbar">
      <div class="row">
        <label for="checklistDate">Date:</label>
        <input type="date" id="checklistDate" value="2025-10-11" />
        <label for="sheetSelect">Sheet:</label>
        <select id="sheetSelect" title="Choose a sheet"></select>
        <button class="btn btn-secondary" id="newSheetBtn">New</button>
        <button class="btn btn-secondary" id="renameSheetBtn">Rename</button>
        <button class="btn btn-danger" id="deleteSheetBtn">Delete</button>
      </div>
      <div class="row">
        <span id="saveStatus" class="save-status">Auto-save ready</span>
        <label for="presetSelect">Theme Preset:</label>
        <select id="presetSelect" title="Choose a preset theme"></select>
        <label for="fontSelect">Font:</label>
        <select id="fontSelect" title="Choose a font"></select>
        <button class="btn btn-primary" id="printBtn">Print / Save as PDF</button>
        <button class="btn btn-danger" id="resetBtn" title="Fix problems by clearing cache & data">Reset (Fix)</button>
      </div>
    </div>

    <div class="section" id="section-1st"><div class="section-title">1st of Month</div><ul class="checklist" id="list-1st"></ul></div>
    <div class="section" id="section-before5th"><div class="section-title">Before the 5th</div><ul class="checklist" id="list-before5th"></ul></div>
    <div class="section" id="section-monthly"><div class="section-title">Monthly</div><ul class="checklist" id="list-monthly"></ul></div>
    <div class="section" id="section-biweekly"><div class="section-title">Bi-Weekly</div><ul class="checklist" id="list-biweekly"></ul></div>
    <div class="section" id="section-daily"><div class="section-title">Daily</div><ul class="checklist" id="list-daily"></ul></div>

    <div class="section" id="section-custom">
      <div class="section-title">Custom Items (Movable between sections)</div>
      <ul class="checklist" id="list-custom"></ul>
      <div style="display:flex;justify-content:center;margin-top:10px;">
        <button class="btn btn-primary" id="addRowBtn">+ Add Row</button>
      </div>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instrModal">
    <div class="card">
      <div class="card-head">
        <div id="instrTitle" style="font-weight:800;font-size:16px;">Task Instructions</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="editInstrBtn" class="btn btn-secondary" title="Add or edit instructions">Add / Edit</button>
          <button id="closeInstrBtn" class="btn btn-danger" title="Close">Close</button>
        </div>
      </div>
      <div class="card-body" id="instrBody"></div>
    </div>
  </div>

  <!-- Useful Links Toggle & Section -->
  <div style="margin: 24px;">
    <button id="toggleLinksBtn" class="btn btn-secondary" style="margin-bottom:10px;">
      Show Useful Links
    </button>

    <section id="usefulLinks" style="display:none; border-top: 2px solid var(--line); padding-top: 16px;">
      <h2 style="font-size:1.2rem; font-weight:700; margin:0 0 12px;">Useful Links</h2>
      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <a href="https://secure.therapservices.net/ma/isp/ispDataSearch?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">ISP Search</a>
        <a href="https://secure.therapservices.net/ma/mar/marDataSearch?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">MAR Search</a>
        <a href="https://secure.therapservices.net/ma/tlog/programList?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">New Tlog</a>
        <a href="https://secure.therapservices.net/ma/ger/programList?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">GER</a>
        <a href="https://secure.therapservices.net/ma/hlth/appointments/individualList" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">New Appt</a>
        <a href="https://secure.therapservices.net/ma/hlth/appSearch" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">Search Appt</a>
        <a href="https://secure.therapservices.net/ma/hlth/appointment/calendar?backLink=%2Fnewfpage%2FswitchFirstPage&backType=1" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">Appt Calendar</a>
        <a href="https://webtime2.paylocity.com/webtime/v3/schedule" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="text-decoration:none; padding:10px 18px; border-radius:8px;">House Schedule</a>
      </div>
    </section>
  </div>

  <div id="errOverlay" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#fffbdd;color:#111;border-top:1px solid #f4e5a3;padding:8px 12px;font-family:monospace;font-size:12px;z-index:99999;"></div>

<script>
(function(){
  // Simple error overlay
  var errEl = document.getElementById('errOverlay');
  window.onerror = function(message, source, lineno, colno, error){
    try {
      if(!errEl) return;
      errEl.style.display = 'block';
      errEl.textContent = 'Error: ' + message + ' @ ' + (source||'') + ':' + (lineno||'') + ':' + (colno||'');
    } catch(e){}
  };

  function ready(fn){
    if(document.readyState !== 'loading'){ fn(); }
    else { document.addEventListener('DOMContentLoaded', fn); }
  }

  ready(function(){
    // Keys
    var SHEETS_KEY='nes_manager_checklist_sheets_v1';
    var STORAGE_PREFIX='nes_manager_checklist_sheet_';
    var THEME_PREFIX='nes_manager_checklist_theme_';
    var THEME_PRESET_PREFIX='nes_manager_checklist_theme_preset_';
    var FONT_KEY_PREFIX='nes_manager_checklist_font_';
    var INSTR_PREFIX='nes_manager_checklist_instructions_';
    var LINKS_VIS_PREFIX='nes_manager_checklist_links_visible_';
    var LAST_SHEET_KEY='nes_manager_checklist_last_sheet';
    var DEFAULT_SHEET='Default';
    var lists=['list-1st','list-before5th','list-monthly','list-biweekly','list-daily','list-custom'];
    function keyFor(p,n){ return p+n; }

    // Elements
    var presetSelect = document.getElementById('presetSelect');
    var fontSelect = document.getElementById('fontSelect');
    var sheetSelect = document.getElementById('sheetSelect');
    var printBtn = document.getElementById('printBtn');
    var resetBtn = document.getElementById('resetBtn');
    var saveStatus = document.getElementById('saveStatus');

    // Helpers
    function getSheets(){ try{ var t=localStorage.getItem(SHEETS_KEY); return t?JSON.parse(t):[DEFAULT_SHEET]; }catch(e){ return [DEFAULT_SHEET]; } }
    function saveSheets(arr){ try{ localStorage.setItem(SHEETS_KEY, JSON.stringify(arr)); }catch(e){} }
    function currentSheet(){ return sheetSelect.value||DEFAULT_SHEET; }

    // Themes & Fonts
    var PRESETS=[
      { id:'biz-min', name:'Business â€” Minimal', t:{bg:'#ffffff',text:'#334155',line:'#cbd5e1',btnPrimaryBg:'#334155',btnPrimaryBorder:'#334155',btnSecondaryBg:'#f8fafc',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'biz-navy', name:'Business â€” Navy', t:{bg:'#ffffff',text:'#1f2937',line:'#e5e7eb',btnPrimaryBg:'#0b3d91',btnPrimaryBorder:'#0b3d91',btnSecondaryBg:'#f3f4f6',btnSecondaryBorder:'#e5e7eb',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'biz-exec', name:'Business â€” Executive', t:{bg:'#ffffff',text:'#111827',line:'#e5e7eb',btnPrimaryBg:'#0f766e',btnPrimaryBorder:'#0f766e',btnSecondaryBg:'#f9fafb',btnSecondaryBorder:'#e5e7eb',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
      { id:'biz-slate', name:'Business â€” Slate', t:{bg:'#f8fafc',text:'#0f172a',line:'#e2e8f0',btnPrimaryBg:'#0f172a',btnPrimaryBorder:'#0f172a',btnSecondaryBg:'#f1f5f9',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'biz-emerald', name:'Business â€” Emerald', t:{bg:'#ffffff',text:'#0f172a',line:'#e5e7eb',btnPrimaryBg:'#065f46',btnPrimaryBorder:'#065f46',btnSecondaryBg:'#ecfdf5',btnSecondaryBorder:'#d1fae5',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'biz-maroon', name:'Business â€” Maroon', t:{bg:'#ffffff',text:'#1f2937',line:'#e5e7eb',btnPrimaryBg:'#7f1d1d',btnPrimaryBorder:'#7f1d1d',btnSecondaryBg:'#faf5f5',btnSecondaryBorder:'#fde2e2',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'cute-blossom', name:'Cute â€” Blossom', t:{bg:'#fff7fb',text:'#5b2245',line:'#f3cfe1',btnPrimaryBg:'#ec4899',btnPrimaryBorder:'#ec4899',btnSecondaryBg:'#fde5f1',btnSecondaryBorder:'#f3cfe1',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
      { id:'cute-lavender', name:'Cute â€” Lavender', t:{bg:'#faf5ff',text:'#4c1d95',line:'#e9d5ff',btnPrimaryBg:'#7c3aed',btnPrimaryBorder:'#7c3aed',btnSecondaryBg:'#f3e8ff',btnSecondaryBorder:'#e9d5ff',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },
      { id:'cute-mint', name:'Cute â€” Mint', t:{bg:'#f0fff4',text:'#065f46',line:'#a7f3d0',btnPrimaryBg:'#10b981',btnPrimaryBorder:'#10b981',btnSecondaryBg:'#d1fae5',btnSecondaryBorder:'#a7f3d0',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },
      { id:'cute-sky', name:'Cute â€” Sky', t:{bg:'#eff6ff',text:'#1e40af',line:'#bfdbfe',btnPrimaryBg:'#3b82f6',btnPrimaryBorder:'#3b82f6',btnSecondaryBg:'#dbeafe',btnSecondaryBorder:'#bfdbfe',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
      { id:'cute-peach', name:'Cute â€” Peach', t:{bg:'#fff7ed',text:'#7c2d12',line:'#fed7aa',btnPrimaryBg:'#f97316',btnPrimaryBorder:'#f97316',btnSecondaryBg:'#ffedd5',btnSecondaryBorder:'#fed7aa',btnDangerBg:'#ffe4e6',btnDangerBorder:'#fecdd3'} },
      { id:'cute-lemon', name:'Cute â€” Lemon', t:{bg:'#fefce8',text:'#713f12',line:'#fde68a',btnPrimaryBg:'#eab308',btnPrimaryBorder:'#eab308',btnSecondaryBg:'#fef9c3',btnSecondaryBorder:'#fde68a',btnDangerBg:'#fff1f2',btnDangerBorder:'#ffe4e6'} },
      { id:'color-ocean', name:'Color â€” Ocean', t:{bg:'#f0f9ff',text:'#0c4a6e',line:'#bae6fd',btnPrimaryBg:'#0369a1',btnPrimaryBorder:'#0369a1',btnSecondaryBg:'#e0f2fe',btnSecondaryBorder:'#bae6fd',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'color-forest', name:'Color â€” Forest', t:{bg:'#f7fee7',text:'#14532d',line:'#d9f99d',btnPrimaryBg:'#15803d',btnPrimaryBorder:'#15803d',btnSecondaryBg:'#ecfccb',btnSecondaryBorder:'#d9f99d',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'color-sunset', name:'Color â€” Sunset', t:{bg:'#fff7ed',text:'#7c2d12',line:'#fed7aa',btnPrimaryBg:'#ea580c',btnPrimaryBorder:'#ea580c',btnSecondaryBg:'#ffedd5',btnSecondaryBorder:'#fed7aa',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'color-rose', name:'Color â€” Rose', t:{bg:'#fff1f2',text:'#881337',line:'#fecdd3',btnPrimaryBg:'#e11d48',btnPrimaryBorder:'#e11d48',btnSecondaryBg:'#ffe4e6',btnSecondaryBorder:'#fecdd3',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'color-plum', name:'Color â€” Plum', t:{bg:'#faf5ff',text:'#3b0764',line:'#e9d5ff',btnPrimaryBg:'#6d28d9',btnPrimaryBorder:'#6d28d9',btnSecondaryBg:'#f3e8ff',btnSecondaryBorder:'#e9d5ff',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} },
      { id:'color-slate', name:'Color â€” Slate', t:{bg:'#f8fafc',text:'#0f172a',line:'#e2e8f0',btnPrimaryBg:'#0f172a',btnPrimaryBorder:'#0f172a',btnSecondaryBg:'#f1f5f9',btnSecondaryBorder:'#e2e8f0',btnDangerBg:'#fee2e2',btnDangerBorder:'#fecaca'} }
    ];
    var FONTS=[
      {id:'system', name:'System Sans', css:'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif', weight:400},
      {id:'inter', name:'Inter', css:'Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif', weight:400},
      {id:'georgia', name:'Georgia', css:'Georgia, Cambria, serif', weight:400},
      {id:'arial', name:'Arial', css:'Arial, Helvetica, sans-serif', weight:400},
      {id:'arial-bold', name:'Arial â€” Bold', css:'Arial, Helvetica, sans-serif', weight:700},
      {id:'helvetica', name:'Helvetica', css:'Helvetica, Arial, sans-serif', weight:400},
      {id:'helvetica-bold', name:'Helvetica â€” Bold', css:'Helvetica, Arial, sans-serif', weight:700},
      {id:'segoe', name:'Segoe UI', css:'Segoe UI, Roboto, Helvetica, Arial, sans-serif', weight:400},
      {id:'segoe-bold', name:'Segoe UI â€” Bold', css:'Segoe UI, Roboto, Helvetica, Arial, sans-serif', weight:700},
      {id:'verdana', name:'Verdana', css:'Verdana, Geneva, sans-serif', weight:400},
      {id:'verdana-bold', name:'Verdana â€” Bold', css:'Verdana, Geneva, sans-serif', weight:700},
      {id:'trebuchet', name:'Trebuchet MS', css:'Trebuchet MS, Segoe UI, Arial, sans-serif', weight:400},
      {id:'trebuchet-bold', name:'Trebuchet â€” Bold', css:'Trebuchet MS, Segoe UI, Arial, sans-serif', weight:700},
      {id:'garamond', name:'Garamond', css:'Garamond, Georgia, serif', weight:400},
      {id:'garamond-bold', name:'Garamond â€” Bold', css:'Garamond, Georgia, serif', weight:700}
    ];

    function themeKey(){ return keyFor(THEME_PREFIX,currentSheet()); }
    function presetKey(){ return keyFor(THEME_PRESET_PREFIX,currentSheet()); }
    function fontKey(){ return keyFor(FONT_KEY_PREFIX,currentSheet()); }
    function instrKey(){ return keyFor(INSTR_PREFIX,currentSheet()); }
    function linksKey(){ return keyFor(LINKS_VIS_PREFIX,currentSheet()); }
    function stateKey(){ return keyFor(STORAGE_PREFIX,currentSheet()); }

    function defaultTheme(){
      return {font:'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif', bg:'#ffffff', text:'#222', line:'#AAA',
              btnPrimaryBg:'#003366', btnPrimaryBorder:'#003366', btnSecondaryBg:'#f5f5f5', btnSecondaryBorder:'#ddd', btnDangerBg:'#ffe7ea', btnDangerBorder:'#ffcbd2'};
    }
    function applyTheme(t){
      var root=document.documentElement;
      if(t.font) root.style.setProperty('--font', t.font);
      root.style.setProperty('--bg', t.bg); root.style.setProperty('--text', t.text); root.style.setProperty('--line', t.line);
      root.style.setProperty('--btn-primary-bg', t.btnPrimaryBg); root.style.setProperty('--btn-primary-border', t.btnPrimaryBorder);
      root.style.setProperty('--btn-secondary-bg', t.btnSecondaryBg); root.style.setProperty('--btn-secondary-border', t.btnSecondaryBorder);
      root.style.setProperty('--btn-danger-bg', t.btnDangerBg); root.style.setProperty('--btn-danger-border', t.btnDangerBorder);
    }
    function saveTheme(t){ try{ localStorage.setItem(themeKey(), JSON.stringify(t)); }catch(e){} applyTheme(t); }
    function loadTheme(){
      var t=defaultTheme(); try{ var raw=localStorage.getItem(themeKey()); if(raw) t = (function(a,b){for(var k in b){a[k]=b[k];} return a;})(t, JSON.parse(raw)); }catch(e){}
      applyTheme(t); try{ var p=localStorage.getItem(presetKey()); presetSelect.value=p||''; }catch(e){}
    }
    function loadPresetOptions(){
      presetSelect.innerHTML='';
      var customOpt=document.createElement('option'); customOpt.value=''; customOpt.textContent='Custom'; presetSelect.appendChild(customOpt);
      for(var i=0;i<PRESETS.length;i++){ var p=PRESETS[i]; var o=document.createElement('option'); o.value=p.id; o.textContent=p.name; presetSelect.appendChild(o); }
    }
    function applyPreset(id){
      var f=null; for(var i=0;i<PRESETS.length;i++){ if(PRESETS[i].id===id){ f=PRESETS[i]; break; } }
      if(f){ var base=defaultTheme(); for(var k in f.t){ base[k]=f.t[k]; } saveTheme(base); try{ localStorage.setItem(presetKey(), id); }catch(e){} }
    }
    presetSelect.addEventListener('change', function(){ applyPreset(presetSelect.value); });

    function loadFontOptions(){ fontSelect.innerHTML=''; for(var i=0;i<FONTS.length;i++){ var f=FONTS[i]; var o=document.createElement('option'); o.value=f.id; o.textContent=f.name; fontSelect.appendChild(o); } }
    function applyFontId(id){ var f=FONTS[0]; for(var i=0;i<FONTS.length;i++){ if(FONTS[i].id===id){ f=FONTS[i]; break; } } var root=document.documentElement; root.style.setProperty('--font', f.css); root.style.setProperty('--font-weight', (f.weight||400)); }
    function loadFont(){ var id='system'; try{ var t=localStorage.getItem(fontKey()); if(t) id=t; }catch(e){} fontSelect.value=id; applyFontId(id); }
    fontSelect.addEventListener('change', function(){ var id=fontSelect.value; applyFontId(id); try{ localStorage.setItem(fontKey(), id); }catch(e){} });

    function collectState(){
      var sections={};
      for(var i=0;i<lists.length;i++){
        var id=lists[i]; var ul=document.getElementById(id);
        var arr=[]; var items=ul.querySelectorAll('li.item');
        for(var j=0;j<items.length;j++){
          var li=items[j]; var chk=li.querySelector('input[type="checkbox"]'); var lbl=li.querySelector('.label');
          arr.push({label: (lbl?lbl.textContent:''), checked: !!(chk && chk.checked)});
        }
        sections[id]=arr;
      }
      return { date: document.getElementById('checklistDate').value, sections: sections };
    }
    function applyState(s){
      if(!s) return;
      if(s.date) document.getElementById('checklistDate').value=s.date;
      for(var i=0;i<lists.length;i++){
        var id=lists[i]; var ul=document.getElementById(id); ul.innerHTML='';
        var arr=(s.sections && s.sections[id])? s.sections[id] : [];
        for(var j=0;j<arr.length;j++){ var it=arr[j]; var li=mkItem(it.label, id==='list-custom'); var chk=li.querySelector('input[type="checkbox"]'); if(chk) chk.checked=!!it.checked; ul.appendChild(li); }
      }
      renumberCustom(); ensureTimesheetSmsButton();
    }
    function saveState(){ try{ localStorage.setItem(stateKey(), JSON.stringify(collectState())); setStatus('Saved'); }catch(e){ setStatus('Save error'); } }
    function setStatus(msg){ var el=document.getElementById('saveStatus'); if(el){ try{ el.textContent = msg + ' â€¢ ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }catch(e){ el.textContent = msg; } } }
    function initDefaults(){
      var defaults={
        'list-1st':[ "Client Medical Assessment Form","RHS Absentee Form","House Sign-in Sheet","Fire Drill / Natural Disaster Drill","PRN Start Count" ],
        'list-before5th':[ "Monthly summaries and monthly appointment","Emails to Support Coordinator" ],
        'list-monthly':[ "House Meeting Notes (Due in Ben office after meeting)","Manager Meeting","Financials" ],
        'list-biweekly':[ "Timesheets / Absentee Sheet","Check in Times for Accuracy" ],
        'list-daily':[ "Check MARs and notes of your staff" ],
        'list-custom':[ "Custom item 1","Custom item 2","Custom item 3" ]
      };
      for(var i=0;i<lists.length;i++){ var id=lists[i]; var ul=document.getElementById(id); ul.innerHTML=''; var d=defaults[id]; for(var j=0;j<d.length;j++){ ul.appendChild(mkItem(d[j], id==='list-custom')); } }
      renumberCustom(); saveState();
    }

    // Sheets
    function refreshSheets(){ var names=getSheets(); sheetSelect.innerHTML=''; for(var i=0;i<names.length;i++){ var o=document.createElement('option'); o.value=names[i]; o.textContent=names[i]; sheetSelect.appendChild(o); } }
    function ensureDefault(){ var names=getSheets(); var found=false; for(var i=0;i<names.length;i++){ if(names[i]===DEFAULT_SHEET){ found=true; break; } } if(!found){ names.unshift(DEFAULT_SHEET); saveSheets(names); } }
    function loadStateForCurrent(){ try{ var raw=localStorage.getItem(stateKey()); if(raw) applyState(JSON.parse(raw)); else initDefaults(); }catch(e){ initDefaults(); } }
    function setLastSheet(name){ try{ localStorage.setItem(LAST_SHEET_KEY, name); }catch(e){} }

    ensureDefault(); refreshSheets();
    (function selectInitialSheet(){
      var names=getSheets(); var last=null; try{ last=localStorage.getItem(LAST_SHEET_KEY); }catch(e){}
      var pick = (last && names.indexOf(last)>=0) ? last : (names[0]||DEFAULT_SHEET);
      sheetSelect.value = pick;
    })();

    loadTheme(); loadFont(); loadPresetOptions(); loadStateForCurrent(); loadLinksVisible(); ensureTimesheetSmsButton();

    document.getElementById('newSheetBtn').addEventListener('click', function(){
      var name=(prompt('Sheet name:', 'New Sheet')||'').trim(); if(!name) return; var names=getSheets(); if(names.indexOf(name)>=0) return alert('Name exists');
      names.push(name); saveSheets(names); refreshSheets(); sheetSelect.value=name; setLastSheet(name); initDefaults(); loadLinksVisible();
    });
    document.getElementById('renameSheetBtn').addEventListener('click', function(){
      var old=sheetSelect.value||DEFAULT_SHEET; if(old===DEFAULT_SHEET) return alert('Default cannot be renamed');
      var name=(prompt('New name:', old)||'').trim(); if(!name) return; var names=getSheets(); if(names.indexOf(name)>=0) return alert('Name exists');
      var idx=names.indexOf(old); names[idx]=name; saveSheets(names);
      localStorage.setItem(keyFor(STORAGE_PREFIX,name), localStorage.getItem(keyFor(STORAGE_PREFIX,old)));
      localStorage.setItem(keyFor(THEME_PREFIX,name), localStorage.getItem(keyFor(THEME_PREFIX,old)));
      localStorage.setItem(keyFor(THEME_PRESET_PREFIX,name), localStorage.getItem(keyFor(THEME_PRESET_PREFIX,old)));
      localStorage.setItem(keyFor(FONT_KEY_PREFIX,name), localStorage.getItem(keyFor(FONT_KEY_PREFIX,old)));
      localStorage.setItem(keyFor(INSTR_PREFIX,name), localStorage.getItem(keyFor(INSTR_PREFIX,old)));
      localStorage.setItem(keyFor(LINKS_VIS_PREFIX,name), localStorage.getItem(keyFor(LINKS_VIS_PREFIX,old)));
      localStorage.removeItem(keyFor(STORAGE_PREFIX,old)); localStorage.removeItem(keyFor(THEME_PREFIX,old)); localStorage.removeItem(keyFor(THEME_PRESET_PREFIX,old)); localStorage.removeItem(keyFor(FONT_KEY_PREFIX,old)); localStorage.removeItem(keyFor(INSTR_PREFIX,old)); localStorage.removeItem(keyFor(LINKS_VIS_PREFIX,old));
      refreshSheets(); sheetSelect.value=name; setLastSheet(name); loadStateForCurrent(); loadTheme(); loadFont(); loadLinksVisible();
    });
    document.getElementById('deleteSheetBtn').addEventListener('click', function(){
      var name=sheetSelect.value||DEFAULT_SHEET; if(name===DEFAULT_SHEET) return alert('Default cannot be deleted');
      if(!confirm('Delete sheet "'+name+'"?')) return; var names=getSheets().filter(function(n){ return n!==name; }); saveSheets(names);
      localStorage.removeItem(keyFor(STORAGE_PREFIX,name)); localStorage.removeItem(keyFor(THEME_PREFIX,name)); localStorage.removeItem(keyFor(THEME_PRESET_PREFIX,name)); localStorage.removeItem(keyFor(FONT_KEY_PREFIX,name)); localStorage.removeItem(keyFor(INSTR_PREFIX,name)); localStorage.removeItem(keyFor(LINKS_VIS_PREFIX,name));
      refreshSheets(); var pick=names[0]||DEFAULT_SHEET; sheetSelect.value=pick; setLastSheet(pick); loadStateForCurrent(); loadTheme(); loadFont(); loadLinksVisible();
    });
    sheetSelect.addEventListener('change', function(){ setLastSheet(sheetSelect.value); loadStateForCurrent(); loadTheme(); loadFont(); loadLinksVisible(); });

    // Instructions
    var instrModal=document.getElementById('instrModal');
    var instrTitle=document.getElementById('instrTitle');
    var instrBody=document.getElementById('instrBody');
    var closeInstrBtn=document.getElementById('closeInstrBtn');
    var editInstrBtn=document.getElementById('editInstrBtn');
    function getInstrMap(){ try{ var raw=localStorage.getItem(instrKey()); return raw?JSON.parse(raw):{}; }catch(e){ return {}; } }
    function saveInstrMap(map){ try{ localStorage.setItem(instrKey(), JSON.stringify(map)); }catch(e){} }
    var currentTaskKey=null;
    function openInstr(titleText){ currentTaskKey=(titleText||'').trim(); var map=getInstrMap(); var txt=map[currentTaskKey] || 'No instructions available yet.'; instrTitle.textContent=currentTaskKey || 'Task Instructions'; instrBody.textContent=txt; instrModal.style.display='flex'; }
    function closeInstr(){ instrModal.style.display='none'; }
    closeInstrBtn.addEventListener('click', closeInstr);
    instrModal.addEventListener('click', function(e){ if(e.target===instrModal) closeInstr(); });
    editInstrBtn.addEventListener('click', function(){ if(!currentTaskKey) return; var map=getInstrMap(); var prev=map[currentTaskKey]||''; var next=prompt('Instructions for: '+currentTaskKey, prev); if(next===null) return; map[currentTaskKey]=(next||'').trim(); saveInstrMap(map); instrBody.textContent=map[currentTaskKey]||'No instructions available yet.'; });
    document.addEventListener('click', function(e){ var lbl=e.target && e.target.classList && e.target.classList.contains('label') ? e.target : (e.target.closest? e.target.closest('.label') : null); if(!lbl) return; var titleText=lbl.textContent||''; if((titleText.replace(/\s+/g,'')).length===0) return; openInstr(titleText); });

    // Drag & drop
    var dragEl=null; var placeholder=document.createElement('div'); placeholder.className='placeholder';
    function getAfter(ul, y){
      var els=ul.querySelectorAll('li.item:not(.dragging)');
      var closest={offset:-Infinity, element:null};
      for(var i=0;i<els.length;i++){ var child=els[i]; var box=child.getBoundingClientRect(); var offset=y-box.top-box.height/2; if(offset<0 && offset>closest.offset){ closest={offset:offset, element:child}; } }
      return closest.element;
    }
    document.addEventListener('dragstart', function(e){ var li=(e.target.closest? e.target.closest('li.item') : null); if(!li) return; dragEl=li; li.classList.add('dragging'); });
    document.addEventListener('dragend', function(e){ if(!dragEl) return; dragEl.classList.remove('dragging'); dragEl=null; placeholder.parentNode && placeholder.parentNode.removeChild(placeholder); renumberCustom(); saveState(); });
    var uls=document.querySelectorAll('ul.checklist');
    for(var i=0;i<uls.length;i++){ (function(ul){ ul.addEventListener('dragover', function(e){ e.preventDefault(); var after=getAfter(ul, e.clientY); if(!after) ul.appendChild(placeholder); else ul.insertBefore(placeholder, after); }); ul.addEventListener('drop', function(e){ e.preventDefault(); if(!dragEl) return; ul.insertBefore(dragEl, placeholder); placeholder.parentNode && placeholder.parentNode.removeChild(placeholder); }); })(uls[i]); }
    function renumberCustom(){ var rows=document.querySelectorAll('#list-custom li.item'); var i=1; for(var k=0;k<rows.length;k++){ var li=rows[k]; var n=li.querySelector('.num'); if(!n){ n=document.createElement('div'); n.className='num'; li.insertBefore(n, li.querySelector('.label')); } n.textContent=(i++)+'.'; } }

    // Delete & Add
    document.addEventListener('click', function(e){ var del=(e.target && e.target.classList && e.target.classList.contains('del')) ? e.target : (e.target.closest? e.target.closest('.del') : null); if(del){ var li=del.closest('li.item'); if(li){ li.parentNode.removeChild(li); renumberCustom(); saveState(); } } });
    var addRowBtn = document.getElementById('addRowBtn'); if(addRowBtn){ addRowBtn.addEventListener('click', function(){ var ul=document.getElementById('list-custom'); ul.appendChild(mkItem('New custom item', true)); renumberCustom(); saveState(); }); }
    if(printBtn){ printBtn.addEventListener('click', function(){ window.print(); }); }
    if(resetBtn){ resetBtn.addEventListener('click', function(){ try{ localStorage.clear(); }catch(e){} alert('Local data cleared. Reloading...'); location.reload(true); }); }

    // SMS button on Timesheets
    function ensureTimesheetSmsButton(){
      var ul=document.getElementById('list-biweekly'); if(!ul) return;
      var items=ul.querySelectorAll('li.item');
      for(var i=0;i<items.length;i++){
        var li=items[i]; if(li.querySelector('.sms-action')) continue;
        var lbl=li.querySelector('.label'); if(!lbl) continue;
        var text=(lbl.textContent||'').toLowerCase();
        if(text.indexOf('timesheets')>-1){
          var btn=document.createElement('button'); btn.className='btn btn-secondary sms-action'; btn.textContent='Text Timesheet Completed'; btn.style.marginLeft='8px';
          btn.addEventListener('click', function(ev){ ev.stopPropagation(); sendTimesheetCompleted(); });
          li.appendChild(btn);
        }
      }
    }
    function sendTimesheetCompleted(){
      var number='4358400847'; var body='Timesheet is completed and ready for you.';
      var enc=encodeURIComponent(body);
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      var url = isIOS ? ('sms:'+number+'&body='+enc) : ('sms:'+number+'?body='+enc);
      window.location.href = url;
    }
    document.addEventListener('input', function(e){ if(e.target && e.target.classList && e.target.classList.contains('label')) ensureTimesheetSmsButton(); });

    // Useful Links visibility
    function setLinksVisible(visible){ var sec=document.getElementById('usefulLinks'); var btn=document.getElementById('toggleLinksBtn'); if(!sec||!btn) return; sec.style.display = visible ? 'block' : 'none'; btn.textContent = visible ? 'Hide Useful Links' : 'Show Useful Links'; try{ localStorage.setItem(linksKey(), JSON.stringify(!!visible)); }catch(e){} }
    function loadLinksVisible(){ var visible=false; try{ var raw=localStorage.getItem(linksKey()); if(raw!==null) visible = JSON.parse(raw)===true; }catch(e){} setLinksVisible(visible); }
    var toggleBtn = document.getElementById('toggleLinksBtn'); if(toggleBtn){ toggleBtn.addEventListener('click', function(){ var sec=document.getElementById('usefulLinks'); setLinksVisible(!(sec && sec.style.display!=='none')); }); }

    // Save triggers
    function debounce(fn, ms){ var t=null; return function(){ var ctx=this, args=arguments; if(t) clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx, args); }, ms); }; }
    var debouncedSave = debounce(saveState, 250);
    document.getElementById('checklistDate').addEventListener('change', debouncedSave);
    document.addEventListener('change', function(e){ if(e.target && e.target.matches && e.target.matches('ul.checklist input[type="checkbox"]')) debouncedSave(); });
    document.addEventListener('input', function(e){ if(e.target && e.target.classList && e.target.classList.contains('label')) debouncedSave(); });
    document.addEventListener('click', function(e){ if(e.target && e.target.classList && e.target.classList.contains('del')) debouncedSave(); });
    document.addEventListener('dragend', debouncedSave);
    document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='hidden') saveState(); });
    window.addEventListener('beforeunload', function(){ try{ saveState(); }catch(e){} });

    // Builders
    function mkItem(label, withNumber){
      var li=document.createElement('li'); li.className='item'; li.setAttribute('draggable','true');
      li.innerHTML = withNumber ? '<input type="checkbox"/><div class="num"></div><div class="label" contenteditable="true"></div><button class="del" title="Remove">Ã—</button>'
                                : '<input type="checkbox"/><div class="label"></div><button class="del" title="Remove">Ã—</button>';
      li.querySelector('.label').textContent = label || '';
      return li;
    }

  });
})();</script>
</body>
</html>
